!function(){for(var t=0,e=["ms","moz","webkit","o"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var i=(new Date).getTime(),n=Math.max(0,16-(i-t)),a=window.setTimeout(function(){e(i+n)},n);return t=i+n,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),function(){"use strict";var t,e,i,n="data/data.csv",a=15e5,s=d3.format(",.0f"),r=d3.format("04d");$(function(){d3.csv(n,function(t){return{name:t.SCHOOLNAME,code:r(t.SCHOOLCODE),ward:""===t.WARD?null:t.WARD,level:""===t.LEVEL?null:t.LEVEL,enrollment:""===t.ENROLLMENT?null:+t.ENROLLMENT,atRiskCount:""===t.ATRISKCOUNT?null:+t.ATRISKCOUNT,atRiskFunds:""===t.ATRISKTOTAL?null:+t.ATRISKTOTAL,fortyForty:t.FORTYFORTY,budgetLines:{"Dean of Students":+t.DEANOFSTUDENTS,"In-School Suspension Coordinator":+t.ISSCOORDINATOR,"Guidance Counselor":+t.GUIDANCECOUNSELOR,"Attendance Counselor":+t.ATTENDCOUNSELOR,Psychcologist:+t.PSYCH,"Social Worker":+t.SOCIALWORKER,"Intervention Coach":+t.INTERVENTIONCOACH,"English Teacher":+t.ENGLISHTEACHER,"Math Teacher":+t.MATHTEACHER,"Reading Teacher":+t.READINGTEACHER,"Resource Teacher":+t.RESOURCETEACHER,"Science Teacher":+t.SCIENCETEACHER,"Social Studies Teacher":+t.SOCIALSTUDIESTEACHER,"Art Teacher":+t.ARTTEACHER,"Health/PE Teacher":+t.HEALTHTEACHER,"Music Teacher":+t.MUSICTEACHER,"World Language Teacher":+t.LANGUAGETEACHER,"Special Education Teacher":+t.SPEDTEACHER,"Special Education Aide":+t.SPEDAIDE,"Behavior Technician":+t.BEHAVIORTECH,"Assistant Principal for Intervention":+t.ASSTPRINCIPALINTERVENTION,"Reading Specialist":+t.READINGSPECIALIST,"Assistant Principal for Literacy":+t.ASSTPRINCIPALLITERACY,"Proving What's Possible for Student Satisfaction Award":+t.PWPSTUDENTSATISFACTION,"Extended Day Funds":+t.EXTENDEDDAY,"Middle Grade Excursions and Activities":+t.MIDDLEGRADEACTIVITIES,"Evening Credit Recovery":+t.ECR,"Other Funds":+t.OTHER,"New Heights Teen Parent Program":+t.NEWHEIGHTS,"Reading Partners Program":+t.READINGPARTNERS}}},t.initialize)}),t={initialize:function(e){$("#loading").fadeOut(),$("#main").fadeIn(),$("p.what a").click(function(){var t=$.attr(this,"href");return $("html, body").animate({scrollTop:$(t).offset().top},500),!1}),t.data=_.filter(e,"atRiskCount"),t.filterData({}),t.loadView("Bubbles"),$(window).resize(function(){t.view.resize()}),$("#views").change(function(e){t.loadView($(e.target).attr("value"))}),$("#filters").change(function(){var e={};$("#filters input:checked").each(function(){var t=$(this),i=t.attr("value");i&&(e[t.attr("name")]=i)}),t.filterData(e)})},filterData:function(e){var i=_(t.data).forEach(function(t){t.filtered=!1});_.isEmpty(e)||i.reject(e).forEach(function(t){t.filtered=!0}),t.view&&t.view.refresh()},loadView:function(i){clearTimeout(window.quickUglyGlobalTimeout),$("#exhibit").empty(),$("#school-view").hide(),t.view=new e[i](t.data)}},window.app=t,e={},e.Bubbles=function(t){var e=this;this.margin={top:120,right:20,bottom:40,left:60},this.data=t,this.$el=$("#exhibit"),this.$el.css("overflow","visible"),window.quickUglyGlobalTimeout=setTimeout(function(){e.$el.css("overflow","hidden")},900),this.x=d3.scale.linear().domain([0,650]),this.y=d3.scale.linear().domain([0,a]),this.svg=d3.select("#exhibit").append("svg").attr("class","bubble chart"),this.g=this.svg.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")"),this.bg=this.g.append("g"),this.fg=this.g.append("g"),this.interactionLayer=this.g.append("g"),d3.select("#exhibit").append("div").attr("class","instruction").append("h3").text("Hover over a school to view details"),this.mouseover=function(t){e.fg.select(".bubble.school-"+t.code).classed("highlighted",!0).transition().ease("elastic").duration(900).attr("r",18);var i=d3.select("#tooltip");i.selectAll(".field.schoolname").text(t.name),i.selectAll(".field.atriskcount").text(t.atRiskCount),i.selectAll(".field.atriskpercent").text((t.atRiskCount/t.enrollment*100).toFixed(0)),i.selectAll(".field.atriskfunds").text("$"+s(t.atRiskFunds)),i.selectAll(".field.perstudentfunds").text("$"+s(t.atRiskFunds/t.atRiskCount)),i.style("display","block")},this.mouseout=function(t){e.fg.select(".bubble.school-"+t.code).classed("highlighted",!1).transition().ease("elastic").duration(900).attr("r",6),d3.select("#tooltip").style("display","none")},this.click=function(t){i(d3.select("#school-view"),t),$("#school-view").slideDown(),$("#school-view button.close").click(function(){$("#school-view").slideUp()})},$("svg.bubble.chart").on("mousemove",function(t){var i,n=t.pageX;e.pageWidth&&e.pageWidth<n+396?(i=n+409-e.pageWidth,$("#tooltip .arrow").css("left",i>370?370:i),$("#tooltip").css({left:"",right:0})):(i=n-42,$("#tooltip .arrow").css("left",15),$("#tooltip").css({left:i,right:""}))}),this.resize()},e.Bubbles.prototype.resize=function(){var t,e,i=this.$el.width(),n=i-this.margin.left-this.margin.right,r=400-this.margin.top-this.margin.bottom,o=this;this.pageWidth=i+16,this.svg.attr("width",n+this.margin.left+this.margin.right).attr("height",r+this.margin.top+this.margin.bottom),this.x.range([0,n]),this.y.range([r,0]),t=d3.svg.axis().scale(this.x).ticks(n>800?13:6).tickSize(-r-20).orient("bottom"),e=d3.svg.axis().scale(this.y).tickValues([0,25e4,5e5,75e4,1e6,125e4,15e5]).tickFormat(function(t){return"$"+s(t/1e3)+"K"}).tickSize(-n-20).orient("left"),this.voronoi=d3.geom.voronoi().x(function(t){return o.x(t.atRiskCount)}).y(function(t){return t.atRiskFunds>a?-10:o.y(t.atRiskFunds)}).clipExtent([[-20,-20],[n+20,r+20]]),this.bg.selectAll(".axis").remove(),this.bg.selectAll(".guide").remove(),this.bg.append("g").attr("class","x axis").attr("transform","translate(0,"+(r+10)+")").call(t).append("text").attr("class","label").attr("x",n-5).attr("y",-16).style("text-anchor","end").text("# of At-Risk Students"),this.bg.append("g").attr("class","y axis").attr("transform","translate(-10,0)").call(e).append("text").attr("class","label").attr("transform","rotate(-90)").attr("x",-4).attr("y",16).attr("dy",".71em").style("text-anchor","end").text("Total At-Risk Funds"),this.bg.append("line").attr("class","guide").attr("x1",this.x(0)).attr("y1",this.y(0)).attr("x2",this.x(650)).attr("y2",this.y(1351350)),this.bg.append("text").attr("class","guide").attr("x",this.x(650)).attr("y",this.y(1351350)-3).attr("transform","rotate("+Math.atan((this.y(1351350)-this.y(0))/(this.x(650)-this.x(0)))*(180/Math.PI)+" "+this.x(650)+" "+this.y(1351350)+")").style("text-anchor","end").text("Funds Allotted Per Student ($2,079)"),this.refresh()},e.Bubbles.prototype.refresh=function(){var t,e,i=this;t=this.fg.selectAll(".bubble").data(this.data),t.enter().append("circle").attr("class",function(t){return"bubble school-"+t.code}).attr("r",6).attr("cy",this.y(0)),t.attr("cx",function(t){return i.x(t.atRiskCount)}).transition().ease("elastic").duration(900).delay(function(t){return t.atRiskCount/2+300*Math.random()}).attr("r",function(t){return t.filtered?3:6}).attr("cy",function(t){return t.atRiskFunds>a?-10:i.y(t.atRiskFunds)}).each("start",function(){d3.select(this).classed("disabled",function(t){return t.filtered})}),e=this.interactionLayer.selectAll(".voronoi").data(this.voronoi(_.reject(this.data,"filtered"))),e.enter().append("path").attr("class","voronoi").on("mouseover",this.mouseover).on("mouseout",this.mouseout).on("click",this.click),e.attr("d",function(t){return"M"+t.join("L")+"Z"}).datum(function(t){return t.point}),e.exit().remove()},e.Bars=function(t){var e,n=this;this.$el=$("#exhibit"),this.$el.css("overflow","visible"),this.data=t,this.data=_.sortBy(this.data,function(t){return-(t.atRiskFunds/t.atRiskCount)}),this.table=d3.select("#exhibit").append("table").attr("class","bar-chart").attr("summary","DCPS schools sorted by funding recieved per at-risk student"),e=this.table.append("thead").append("tr"),e.append("th").attr("scope","col").text("School Name"),e.append("th").attr("scope","col").text("At-Risk Students"),e.append("th").attr("scope","col").text("At-Risk Funds"),e.append("th").attr("scope","col").text("Funding per Student"),this.tbody=this.table.append("tbody"),this.removeSchoolViews=function(t){$(".bar-chart .school-view").slideUp({duration:t?0:400,complete:function(){$(this).parent().parent().remove()}})},this.click=function(t){if(n.removeSchoolViews(),t.code&&t.code!==n.expandedRow){n.expandedRow=t.code;var e=$("<tr>").addClass("school-view-row"+($(this).hasClass("odd")?" odd":"")),a=$("<td>").attr("colspan",3).appendTo(e),s=$("#school-view").clone().removeAttr("id");i(d3.select(s[0]),t),s.find("button.close").click(function(){n.expandedRow=null,n.removeSchoolViews()}),s.appendTo(a),$(this).after(e),s.slideDown()}else n.expandedRow=null},this.refresh()},e.Bars.prototype.resize=function(){},e.Bars.prototype.refresh=function(){this.removeSchoolViews(!0);var t=function(t){return _.sortBy(t.concat([{name:"Allotted by Funding Formula",atRiskCount:-1,atRiskFunds:-2079,filtered:!1}]),function(t){return-(t.atRiskFunds/t.atRiskCount)})},e=this.data[0],i=e.atRiskFunds/e.atRiskCount,n=this.tbody.selectAll("tr.bar").data(t(this.data)),a=_.template('<td><%= name %></td><td><%= atRiskCount > 0 ? atRiskCount : "" %></td><td><%= atRiskFunds > 0 ? formattedFunds : "" %></td><td><div class="wrapper"><span class="line" style="left: '+2079/i*100+'%;"></span><div class="bar"><span class="rect"></span><%= perStudentFunds %></div></div></td>'),r=0;n.enter().append("tr").attr("class",function(t){return"bar "+(t.code?"school-"+t.code:"allocation")}).html(function(t){return t.formattedFunds="$"+s(t.atRiskFunds),t.perStudentFunds="$"+s(t.atRiskFunds/t.atRiskCount),a(t)}).on("click",this.click),n.each(function(t){d3.select(this).select("span.rect").style("width",t.atRiskFunds/t.atRiskCount/i*100+"%")}),n.classed("filtered",function(t){return t.filtered}).classed("odd",function(t){return t.filtered||(r+=1),r%2===1})},i=function(t,e){var i=t.selectAll("ul.field.budgetlines"),n=t.selectAll("div.chart"),a=e.atRiskCount/e.enrollment,r=35,o=d3.layout.pie().sort(null),l=d3.svg.arc().innerRadius(r-8).outerRadius(r);t.selectAll(".field.schoolname").text(e.name),t.selectAll(".field.atriskcount").text(e.atRiskCount),t.selectAll(".field.enrollment").text(e.enrollment),t.selectAll(".field.atriskfunds").text("$"+s(e.atRiskFunds)),t.selectAll(".field.byformulafunds").text("$"+s(2079*e.atRiskCount)),t.selectAll(".field.perstudentfunds").text("$"+s(e.atRiskFunds/e.atRiskCount)),t.selectAll("a.learndc").attr("href","http://learndc.org/schoolprofiles/view?s="+e.code+"#overview"),i.selectAll("li").remove(),_(e.budgetLines).pairs().filter(function(t){return t[1]>0}).sortBy(function(t){return-t[1]}).each(function(t){i.append("li").html('<span class="amount">$'+s(t[1])+"</span> "+t[0])}),n.selectAll("svg").remove(),n=n.append("svg").attr("width","70px").attr("height","70px").append("g"),n.attr("transform","translate("+r+","+r+")").selectAll(".arc").data(o([0,1])).enter().append("path").attr("class","arc").attr("d",function(t){return this._current=t,l(t)}).data(o([a,1-a])).transition().duration(1e3*a).attrTween("d",function(t){var e=d3.interpolate(this._current,t);return function(t){return l(e(t))}}),n.append("text").attr("class","amount").attr("y",5).style("text-anchor","middle").text("0%").transition().duration(1e3*a).tween("text",function(){var t=function(t){return(a*t*100).toFixed(0)+"%"};return function(e){this.textContent=t(e)}})}}();