!function(){for(var t=0,e=["ms","moz","webkit","o"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var i=(new Date).getTime(),n=Math.max(0,16-(i-t)),a=window.setTimeout(function(){e(i+n)},n);return t=i+n,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),function(){"use strict";var t,e,i="data/data.csv",n=15e5,a=d3.format(",.0f"),r=d3.format("04d");$(function(){d3.csv(i,function(t){return{name:t.SCHOOLNAME,code:r(t.SCHOOLCODE),ward:""===t.WARD?null:t.WARD,level:""===t.LEVEL?null:t.LEVEL,enrollment:""===t.ENROLLMENT?null:+t.ENROLLMENT,atRiskCount:""===t.ATRISKCOUNT?null:+t.ATRISKCOUNT,atRiskFunds:""===t.ATRISKTOTAL?null:+t.ATRISKTOTAL}},t.initialize)}),t={initialize:function(e){$("#loading").fadeOut(),$("#main").fadeIn(),t.data=_.filter(e,"atRiskCount"),t.filterData({}),t.loadView("Bubbles"),$(window).resize(function(){t.view.resize()}),$("#views").change(function(e){t.loadView($(e.target).attr("value"))}),$("#filters").change(function(){var e={};$("#filters input:checked").each(function(){var t=$(this),i=t.attr("value");i&&(e[t.attr("name")]=i)}),t.filterData(e)})},filterData:function(e){var i=_(t.data).forEach(function(t){t.filtered=!1});_.isEmpty(e)||i.reject(e).forEach(function(t){t.filtered=!0}),t.view&&t.view.refresh()},loadView:function(i){$("#exhibit").empty(),t.view=new e[i](t.data)}},window.app=t,e={},e.Bubbles=function(t){this.margin={top:120,right:20,bottom:40,left:60},this.data=t,this.$el=$("#exhibit"),this.x=d3.scale.linear().domain([0,600]),this.y=d3.scale.linear().domain([0,n]),this.svg=d3.select("#exhibit").append("svg").attr("class","bubble chart"),this.g=this.svg.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")"),this.bg=this.g.append("g"),this.fg=this.g.append("g"),this.interactionLayer=this.g.append("g"),this.resize()},e.Bubbles.prototype.resize=function(){var t,e,i=this.$el.width()-this.margin.left-this.margin.right,r=this.$el.height()-this.margin.top-this.margin.bottom,s=this;this.svg.attr("width",i+this.margin.left+this.margin.right).attr("height",r+this.margin.top+this.margin.bottom),this.x.range([0,i]),this.y.range([r,0]),t=d3.svg.axis().scale(this.x).ticks(i>800?12:6).tickSize(-r-20).orient("bottom"),e=d3.svg.axis().scale(this.y).tickValues([0,25e4,5e5,75e4,1e6,125e4,15e5]).tickFormat(function(t){return"$"+a(t/1e3)+"K"}).tickSize(-i-20).orient("left"),this.voronoi=d3.geom.voronoi().x(function(t){return s.x(t.atRiskCount)}).y(function(t){return t.atRiskFunds>n?-10:s.y(t.atRiskFunds)}).clipExtent([[-20,-20],[i+20,r+20]]),this.bg.selectAll(".axis").remove(),this.bg.selectAll(".guide").remove(),this.bg.append("g").attr("class","x axis").attr("transform","translate(0,"+(r+10)+")").call(t).append("text").attr("class","label").attr("x",i-5).attr("y",-16).style("text-anchor","end").text("# of At-Risk Students"),this.bg.append("g").attr("class","y axis").attr("transform","translate(-10,0)").call(e).append("text").attr("class","label").attr("transform","rotate(-90)").attr("x",-4).attr("y",16).attr("dy",".71em").style("text-anchor","end").text("Total At-Risk Funds"),this.bg.append("line").attr("class","guide").attr("x1",this.x(0)).attr("y1",this.y(0)).attr("x2",this.x(600)).attr("y2",this.y(1206375)),this.refresh()},e.Bubbles.prototype.refresh=function(){var t,e,i=this;t=this.fg.selectAll(".bubble").data(this.data),t.enter().append("circle").attr("class",function(t){return"bubble school-"+t.code}).attr("r",6).attr("cy",this.y(0)),t.attr("cx",function(t){return i.x(t.atRiskCount)}).transition().ease("elastic").duration(900).delay(function(t){return t.atRiskCount/2+300*Math.random()}).each("start",function(){d3.select(this).classed("disabled",function(t){return t.filtered})}).attr("r",function(t){return t.filtered?3:6}).attr("cy",function(t){return t.atRiskFunds>n?-10:i.y(t.atRiskFunds)}),t.exit().remove(),e=this.interactionLayer.selectAll(".voronoi").data(this.voronoi(_.reject(this.data,"filtered"))),e.enter().append("path").attr("class","voronoi").on("mouseover",function(t){i.mouseover(t)}).on("mouseout",function(t){i.mouseout(t)}),e.attr("d",function(t){return"M"+t.join("L")+"Z"}).datum(function(t){return t.point}),e.exit().remove()},e.Bubbles.prototype.mouseover=function(t){this.fg.select(".bubble.school-"+t.code).classed("highlighted",!0).transition().ease("elastic").duration(900).attr("r",18),$("#description .template h3").text(t.name),$("#enrollment").text(t.enrollment),$("#atriskcount").text(t.atRiskCount),$("#atriskpercent").text((t.atRiskCount/t.enrollment*100).toFixed(1)),$("#atriskfunds").text("$"+a(t.atRiskFunds)),$("#perstudentfunds").text("$"+a(t.atRiskFunds/t.atRiskCount)),$("#description .placeholder").hide(),$("#description .template").show()},e.Bubbles.prototype.mouseout=function(t){this.fg.select(".bubble.school-"+t.code).classed("highlighted",!1).transition().ease("elastic").duration(900).attr("r",6),$("#description .placeholder").show(),$("#description .template").hide()}}();