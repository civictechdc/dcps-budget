!function(){"use strict";var t,e,a,s="data/data.csv",n=2016,l={enrollment:"Enrollment-based funds",specialty:"Speciality funds",perpupilmin:"Per-pupil minimum",stabilization:"Stabilization funds",sped:"Special education",ell:"English learners",atrisk:"At-risk funds",income:"Income-linked (i.e. Title I)"},i=d3.format(",.0f"),r=d3.format("04d");$(function(){d3.csv(s,function(t){var e={name:t.SCHOOLNAME,year:+t.YEAR,code:r(t.SCHOOLCODE),ward:""===t.WARD?null:t.WARD,level:""===t.LEVEL?null:t.LEVEL,fortyForty:t.FORTYFORTY,budget:{},enrollment:{}};return e.budget[t.YEAR]=[{category:"enrollment",value:+t.ENROLLMENTFUNDS},{category:"specialty",value:+t.SPECIALTY},{category:"perpupilmin",value:+t.PERPUPILMIN},{category:"stabilization",value:+t.STABILIZATION},{category:"sped",value:+t.SPED},{category:"ell",value:+t.ELL},{category:"atrisk",value:+t.ATRISK},{category:"income",value:+t.INCOME}],e.enrollment[t.YEAR]={total:""===t.ENROLLMENT?null:+t.ENROLLMENT,atRisk:""===t.ATRISKENROLLMENT?null:+t.ATRISKENROLLMENT},e},t.initialize)}),t={initialize:function(e){function a(){"gened"===t.globals.category&&"Bars"===t.globals.view?$("#legend").removeClass("hidden"):$("#legend").addClass("hidden")}t.globals={},$("#loading").fadeOut(),$("#main").fadeIn(),$("p.what a").click(function(){var t=$.attr(this,"href");return $("html, body").animate({scrollTop:$(t).offset().top},500),!1});var s=_.partition(e,{year:n});t.data=s[0],_.each(s[1],function(e){var a=_.find(t.data,function(t){return t.code===e.code});a.budget[e.year]=e.budget[e.year],a.enrollment[e.year]=e.enrollment[e.year]}),t.filterData({}),t.setCategory("gened"),t.loadView("Bars"),$(window).resize(function(){t.view.resize()}),$("#views").change(function(e){t.loadView($(e.target).attr("value"))}),$("#filters").change(function(){var e={};$("#filters input:checked").each(function(){var t=$(this),a=t.attr("value");a&&(e[t.attr("name")]=a)}),t.filterData(e),a()}),$("#categories").change(function(e){t.setCategory($(e.target).attr("value")),a()})},filterData:function(e){t.globals.filter=e;var a=_.matches(e);_.each(t.data,function(t){t.filtered=!_.isEmpty(e)&&!a(t)}),t.view&&t.view.refresh()},setCategory:function(e){t.globals.category=e;var a="gened"===e?["enrollment","specialty","perpupilmin","stabilization"]:[e],s=function(t,e){return t+e.value};_.each(t.data,function(t){t.selected={},_.each(t.budget,function(n,l){if("total"===e){var i=_.reduce(n,s,0);t.selected[l]={lines:[{category:"total",value:i}],total:i,fullBudget:i}}else{var r=_.partition(n,function(t){return _.includes(a,t.category)}),o={};o.lines=r[0],o.total=_.reduce(o.lines,s,0),o.lines.push({category:"other",value:_.reduce(r[1],s,0)}),o.fullBudget=_.reduce(o.lines,s,0),t.selected[l]=o}}),t.change=null,_.has(t.selected),n-1&&(t.change=t.selected[n].total/t.selected[n-1].total-1)}),t.view&&t.view.refresh()},loadView:function(a){t.globals.view=a,$("#exhibit").empty(),$("#school-view").hide(),t.view=new e[a](t.data)}},window.app=t,e={},e.Bars=function(t){var e,s=this;this.$el=$("#exhibit"),this.data=_.sortBy(t,function(t){return-(t.selected[n].fullBudget/t.enrollment[n].total)}),this.table=d3.select("#exhibit").append("table").attr("class","bar-chart").attr("summary","Schools by the funding per student"),e=this.table.append("thead").append("tr"),e.append("th").attr("scope","col").attr("data-sort","name").text("School Name").append("span").attr("class","sort-arrow"),e.append("th").attr("scope","col").attr("data-sort","enrollment").attr("class","descending").text("Enrollment").append("span").attr("class","sort-arrow"),e.append("th").attr("scope","col").attr("data-sort","budget").attr("class","selected descending").text("Funds per Student").append("span").attr("class","sort-arrow"),e.append("th").attr("scope","col").attr("data-sort","change").attr("class","descending").text("Change").append("span").attr("class","sort-arrow"),$("table.bar-chart th").click(function(){var t,e=$(this),a=e.data("sort");e.hasClass("selected")&&"name"!==a?e.toggleClass("descending"):($("table.bar-chart th").removeClass("selected"),e.addClass("selected")),t=e.hasClass("descending"),s.refresh(function(e){var s;switch(a){case"budget":s=e.selected[n].total/e.enrollment[n].total;break;case"enrollment":s=e.enrollment[n].total;break;default:s=e[a]}return t?-s:s})}),this.tbody=this.table.append("tbody"),this.removeSchoolViews=function(t){$(".bar-chart .school-view").slideUp({duration:t?0:400,complete:function(){$(this).parent().parent().remove()}})},this.sort=function(t){return-(t.selected[n].total/t.enrollment[n].total)},this.click=function(t){if(s.removeSchoolViews(),t.code&&t.code!==s.expandedRow){s.expandedRow=t.code;var e=$("<tr>").addClass("school-view-row"+($(this).hasClass("odd")?" odd":"")),n=$("<td>").attr("colspan",4).appendTo(e),l=$("#school-view").clone().removeAttr("id");a(d3.select(l[0]),t),l.find("button.close").click(function(){s.expandedRow=null,s.removeSchoolViews()}),l.appendTo(n),$(this).after(e),l.slideDown()}else s.expandedRow=null},this.refresh()},e.Bars.prototype.resize=function(){},e.Bars.prototype.refresh=function(t){this.removeSchoolViews(!0),this.sort=t||this.sort;var e=this.data[0],a=e.selected[n].fullBudget/e.enrollment[n].total,s=this.tbody.selectAll("tr.bar").data(_.sortBy(this.data,this.sort)),l=_.template('<td><%= name %></td><td><%= enrollment[CURRENT_YEAR].total %></td><td><div class="wrapper"><div class="bar"><span class="year"><%= CURRENT_YEAR + ": " %></span><span class="label"><%= "$" + commasFormatter(selected[CURRENT_YEAR].total / enrollment[CURRENT_YEAR].total) %></span><% _.each(selected[CURRENT_YEAR].lines, function (line) { %><span class="rect <%= line.category %>" style="width: <%= (line.value / enrollment[CURRENT_YEAR].total) / max * 100 %>%;"></span><% }); %></div><div class="bar previous-year"><span class="year"><%= CURRENT_YEAR - 1 + ": " %></span><span class="label"><%= "$" + commasFormatter(selected[CURRENT_YEAR - 1].total / enrollment[CURRENT_YEAR - 1].total) %></span><% _.each(selected[CURRENT_YEAR - 1].lines, function (line) { %><span class="rect <%= line.category %>" style="width: <%= (line.value / enrollment[CURRENT_YEAR - 1].total) / max * 100 %>%;"></span><% }); %></div></div></td><td class="<%= change < 0 ? "negative" : "" %>"><%= (change * 100).toFixed(1) + "%" %></td>',{imports:{commasFormatter:i,CURRENT_YEAR:n,max:a}}),r=0;s.enter().append("tr").on("click",this.click),s.attr("class",function(t){return"bar school-"+t.code}).html(function(t){return l(t)}),s.classed("filtered",function(t){return t.filtered}).classed("odd",function(t){return t.filtered||(r+=1),r%2===1}),s.exit().remove()},a=function(t,e){var a=t.selectAll("ul.field.budgetlines"),s=t.selectAll("div.chart"),r=e.enrollment[n].atRisk/e.enrollment[n].total,o=35,c=d3.layout.pie().sort(null),d=d3.svg.arc().innerRadius(o-8).outerRadius(o);t.selectAll(".field.schoolname").text(e.name),t.selectAll(".field.atriskcount").text(e.enrollment[n].atRisk),t.selectAll(".field.enrollment").text(e.enrollment[n].total),t.selectAll("a.learndc").attr("href","http://learndc.org/schoolprofiles/view?s="+e.code+"#overview"),a.selectAll("li").remove(),_.forEach({current:n,previous:n-1},function(a,s){var n=t.selectAll("ul.field.budgetlines."+s+"-year"),r=e.budget[a];_.each(r,function(t){n.append("li").html('<span class="amount">$'+i(t.value/e.enrollment[a].total)+"</span> "+l[t.category])})}),s.selectAll("svg").remove(),s=s.append("svg").attr("width","70px").attr("height","70px").append("g"),s.attr("transform","translate("+o+","+o+")").selectAll(".arc").data(c([0,1])).enter().append("path").attr("class","arc").attr("d",function(t){return this._current=t,d(t)}).data(c([r,1-r])).transition().duration(1e3*r).attrTween("d",function(t){var e=d3.interpolate(this._current,t);return function(t){return d(e(t))}}),s.append("text").attr("class","amount").attr("y",5).style("text-anchor","middle").text("0%").transition().duration(1e3*r).tween("text",function(){var t=function(t){return(r*t*100).toFixed(0)+"%"};return function(e){this.textContent=t(e)}})},e.Bubbles=function(t){var e=this;this.margin={top:120,right:20,bottom:40,left:60},this.data=t,this.$el=$("#exhibit"),this.x=d3.scale.linear().domain([0,650]),this.y=d3.scale.linear().domain([0,MAX]),this.svg=d3.select("#exhibit").append("svg").attr("class","bubble chart"),this.g=this.svg.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")"),this.bg=this.g.append("g"),this.fg=this.g.append("g"),this.interactionLayer=this.g.append("g"),d3.select("#exhibit").append("div").attr("class","instruction").append("h3").text("Click on a school to view details"),this.mouseover=function(t){e.fg.select(".bubble.school-"+t.code).classed("highlighted",!0).transition().ease("elastic").duration(900).attr("r",18);var a=d3.select("#tooltip");a.selectAll(".field.schoolname").text(t.name),a.selectAll(".field.atriskcount").text(t.atRiskCount),a.selectAll(".field.atriskpercent").text((t.atRiskCount/t.enrollment*100).toFixed(0)),a.selectAll(".field.atriskfunds").text("$"+i(t.atRiskFunds)),a.selectAll(".field.perstudentfunds").text("$"+i(t.atRiskFunds/t.atRiskCount)),a.style("display","block")},this.mouseout=function(t){e.fg.select(".bubble.school-"+t.code).classed("highlighted",!1).transition().ease("elastic").duration(900).attr("r",6),d3.select("#tooltip").style("display","none")},this.click=function(t){a(d3.select("#school-view"),t),$("#school-view").slideDown(),$("#school-view button.close").click(function(){$("#school-view").slideUp()})},$("svg.bubble.chart").on("mousemove",function(t){var a,s=t.pageX;e.pageWidth&&e.pageWidth<s+396?(a=s+409-e.pageWidth,$("#tooltip .arrow").css("left",a>370?370:a),$("#tooltip").css({left:"",right:0})):(a=s-42,$("#tooltip .arrow").css("left",15),$("#tooltip").css({left:a,right:""}))}),this.resize()},e.Bubbles.prototype.resize=function(){var t,e,a=this.$el.width(),s=a-this.margin.left-this.margin.right,n=400-this.margin.top-this.margin.bottom,l=this;this.pageWidth=a+16,this.svg.attr("width",s+this.margin.left+this.margin.right).attr("height",n+this.margin.top+this.margin.bottom),this.x.range([0,s]),this.y.range([n,0]),t=d3.svg.axis().scale(this.x).ticks(s>800?13:6).tickSize(-n-20).orient("bottom"),e=d3.svg.axis().scale(this.y).tickValues([0,25e4,5e5,75e4,1e6,125e4,15e5]).tickFormat(function(t){return"$"+i(t/1e3)+"K"}).tickSize(-s-20).orient("left"),this.voronoi=d3.geom.voronoi().x(function(t){return l.x(t.atRiskCount)}).y(function(t){return t.atRiskFunds>MAX?-10:l.y(t.atRiskFunds)}).clipExtent([[-20,-20],[s+20,n+20]]),this.bg.selectAll(".axis").remove(),this.bg.selectAll(".guide").remove(),this.bg.append("g").attr("class","x axis").attr("transform","translate(0,"+(n+10)+")").call(t).append("text").attr("class","label").attr("x",s-5).attr("y",-16).style("text-anchor","end").text("# of At-Risk Students"),this.bg.append("g").attr("class","y axis").attr("transform","translate(-10,0)").call(e).append("text").attr("class","label").attr("transform","rotate(-90)").attr("x",-4).attr("y",16).attr("dy",".71em").style("text-anchor","end").text("Total At-Risk Funds"),this.bg.append("line").attr("class","guide").attr("x1",this.x(0)).attr("y1",this.y(0)).attr("x2",this.x(650)).attr("y2",this.y(1351350)),this.bg.append("text").attr("class","guide").attr("x",this.x(650)).attr("y",this.y(1351350)-3).attr("transform","rotate("+Math.atan((this.y(1351350)-this.y(0))/(this.x(650)-this.x(0)))*(180/Math.PI)+" "+this.x(650)+" "+this.y(1351350)+")").style("text-anchor","end").text("Funds Allotted Per Student ($2,079)"),this.refresh()},e.Bubbles.prototype.refresh=function(){var t,e,a=this;t=this.fg.selectAll(".bubble").data(this.data),t.enter().append("circle").attr("class",function(t){return"bubble school-"+t.code}).attr("r",6).attr("cy",this.y(0)),t.attr("cx",function(t){return a.x(t.atRiskCount)}).transition().ease("elastic").duration(900).delay(function(t){return t.atRiskCount/2+300*Math.random()}).attr("r",function(t){return t.filtered?3:6}).attr("cy",function(t){return t.atRiskFunds>MAX?-10:a.y(t.atRiskFunds)}).each("start",function(){d3.select(this).classed("disabled",function(t){return t.filtered})}),e=this.interactionLayer.selectAll(".voronoi").data(this.voronoi(_.reject(this.data,"filtered"))),e.enter().append("path").attr("class","voronoi").on("mouseover",this.mouseover).on("mouseout",this.mouseout).on("click",this.click),e.attr("d",function(t){return"M"+t.join("L")+"Z"}).datum(function(t){return t.point}),e.exit().remove()}}();